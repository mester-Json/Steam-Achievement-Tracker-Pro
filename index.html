<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./renderer/style.css" />
    <title>Steam Achievement Tracker Pro</title>
</head>
<body>
<h1>üèÜ Steam Achievement Tracker Pro</h1>

<div id="status" class="info">Initialisation...</div>

<section id="user-selection" class="user-selector" style="display: none;">
    <h2> S√©lectionnez votre profil Steam</h2>
    <div id="user-list" role="list" aria-label="Liste des utilisateurs Steam"></div>
    <div style="text-align: center; margin-top: 25px;">
        <button id="start-btn" onclick="startTracking()" disabled aria-disabled="true"> D√©marrer</button>
    </div>
</section>

<section id="game-selection" class="user-selector" style="display: none;">
    <h2> S√©lectionnez un jeu</h2>
    <div id="game-list" class="game-list" role="list" aria-label="Liste des jeux"></div>
    <div style="text-align: center; margin-top: 15px;">
        <button onclick="testSelectedGame()"> Voir les succ√®s</button>
        <button onclick="watchSelectedGame()"> Surveiller ce jeu</button>
    </div>
</section>

<div id="controls" style="display: none;">
    <button onclick="showGames()"> Choisir un jeu</button>
    <button onclick="changeUser()"> Changer d'utilisateur</button>
</div>

<!-- Container pour les succ√®s avec barre de progression -->
<div id="achievements-container" class="achievements-header" style="display: none;">
    <h3 id="game-title"> Succ√®s</h3>

    <!-- Statistiques -->
    <div class="progress-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
        <div class="stat-box" style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; text-align: center;">
            <h4 style="color: #888; font-size: 0.9rem; margin-bottom: 5px; font-weight: normal;">Total</h4>
            <p id="total-achievements" style="font-size: 1.8rem; font-weight: bold; color: #4CAF50; margin: 0;">0</p>
        </div>
        <div class="stat-box" style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; text-align: center;">
            <h4 style="color: #888; font-size: 0.9rem; margin-bottom: 5px; font-weight: normal;">D√©bloqu√©s</h4>
            <p id="unlocked-achievements" style="font-size: 1.8rem; font-weight: bold; color: #4CAF50; margin: 0;">0</p>
        </div>
        <div class="stat-box" style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; text-align: center;">
            <h4 style="color: #888; font-size: 0.9rem; margin-bottom: 5px; font-weight: normal;">Progression</h4>
            <p id="percentage-achievements" style="font-size: 1.8rem; font-weight: bold; color: #4CAF50; margin: 0;">0%</p>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%">
            <span id="progress-text">0%</span>
        </div>
    </div>
</div>

<div class="filter-buttons" id="filter-container" style="display: none;">
    <button class="active" onclick="setFilter('all', event)">Tous (<span id="filter-all">0</span>)</button>
    <button onclick="setFilter('unlocked', event)">D√©bloqu√©s (<span id="filter-unlocked">0</span>)</button>
    <button onclick="setFilter('locked', event)">Verrouill√©s (<span id="filter-locked">0</span>)</button>
</div>

<div id="achievements" class="achievement-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;" role="list" aria-label="Liste des succ√®s"></div>

<script>
    let selectedUser = null;
    let selectedGame = null;
    let steamUsers = [];
    let userGames = [];
    let currentAchievements = [];
    let currentResult = null;
    let filterMode = 'all';

    async function init() {
        console.log(' Initialisation...');
        const status = document.getElementById('status');

        if (!window.steamAPI) {
            status.textContent = " API Steam non disponible !";
            status.className = "error";
            return;
        }

        status.textContent = " API Steam d√©tect√©e, recherche de Steam...";
        status.className = "info";

        try {
            const steamPath = await window.steamAPI.getSteamPath();
            console.log(' Chemin Steam:', steamPath);

            if (!steamPath) {
                status.textContent = " Steam non trouv√© !";
                status.className = "error";
                return;
            }

            const pathParts = steamPath.split(/[\\/]/);
            const steamFolder = pathParts[pathParts.length - 1];
            status.textContent = ` Steam trouv√©: ${steamFolder}`;
            status.className = "info";

            const result = await window.steamAPI.getSteamUsers();
            console.log(' Utilisateurs Steam:', result);

            if (!result.users || result.users.length === 0) {
                status.textContent = " Aucun compte Steam d√©tect√©.";
                status.className = "warning";
                return;
            }

            steamUsers = result.users;
            displayUsers();

        } catch (error) {
            console.error('Erreur init:', error);
            status.textContent = ` Erreur: ${error.message}`;
            status.className = "error";
        }
    }

    function displayUsers() {
        const userSelection = document.getElementById('user-selection');
        const userList = document.getElementById('user-list');

        userList.innerHTML = '';

        steamUsers.forEach((user, index) => {
            const card = document.createElement('div');
            card.className = 'user-card';
            card.setAttribute('role', 'listitem');
            card.tabIndex = 0;
            card.onclick = (event) => selectUser(user, event);
            card.onkeypress = (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    selectUser(user, event);
                    event.preventDefault();
                }
            };

            const displayName = user.personaName || user.accountName || `Utilisateur ${index + 1}`;

            // Avatar SVG au lieu d'emoji
            const avatarSvg = `<svg class="user-avatar" viewBox="0 0 24 24" fill="#4CAF50" style="width: 60px; height: 60px;">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>`;

            card.innerHTML = `
                ${avatarSvg}
                <div class="user-info">
                    <h3>${displayName}</h3>
                    <p>@${user.accountName || 'N/A'} ${user.mostRecent ? '(R√©cent)' : ''}</p>
                    <small>Steam ID: ${user.steamId || 'N/A'}</small>
                </div>
            `;
            userList.appendChild(card);
        });

        userSelection.style.display = 'block';
        document.getElementById('status').textContent = " S√©lectionnez votre compte Steam";
        document.getElementById('status').className = "info";
    }

    function selectUser(user, event) {
        selectedUser = user;

        const cards = document.querySelectorAll('.user-card');
        cards.forEach(card => card.classList.remove('selected'));
        event.currentTarget.classList.add('selected');

        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = false;
        startBtn.setAttribute('aria-disabled', 'false');

        document.getElementById('status').textContent = ` Compte s√©lectionn√©: ${user.personaName || user.accountName}`;
        document.getElementById('status').className = "info";
    }

    async function startTracking() {
        if (!selectedUser) return;

        document.getElementById('user-selection').style.display = 'none';
        document.getElementById('status').textContent = ` Chargement des jeux de ${selectedUser.personaName || selectedUser.accountName}...`;
        document.getElementById('status').className = "info loading";

        try {
            const games = await window.steamAPI.getUserGames(selectedUser.steamId);
            userGames = games || [];

            if (userGames.length === 0) {
                document.getElementById('status').textContent = "Ô∏è Aucun jeu d√©tect√© pour cet utilisateur.";
                document.getElementById('status').className = "warning";
                return;
            }

            displayGames();
            document.getElementById('status').textContent = `üéÆ ${userGames.length} jeux charg√©s pour ${selectedUser.personaName || selectedUser.accountName}`;
            document.getElementById('status').className = "info";

        } catch (error) {
            console.error(' Erreur r√©cup√©ration jeux:', error);
            document.getElementById('status').textContent = `Erreur lors du chargement des jeux: ${error.message}`;
            document.getElementById('status').className = "error";
        }
    }

    function displayGames() {
        const gameSelection = document.getElementById('game-selection');
        const gameList = document.getElementById('game-list');
        gameList.innerHTML = '';

        userGames.forEach(game => {
            const div = document.createElement('div');
            div.className = 'game-item';
            div.setAttribute('role', 'listitem');
            div.tabIndex = 0;
            div.textContent = game.name;
            div.onclick = () => selectGame(game);
            div.onkeypress = (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    selectGame(game);
                    e.preventDefault();
                }
            };
            gameList.appendChild(div);
        });

        gameSelection.style.display = 'block';
        document.getElementById('controls').style.display = 'block';
        document.getElementById('status').textContent = 'üéÆ S√©lectionnez un jeu';
        document.getElementById('status').className = "info";
    }

    function selectGame(game) {
        selectedGame = game;

        const gameItems = document.querySelectorAll('.game-item');
        gameItems.forEach(item => item.classList.remove('selected'));

        [...gameItems].find(item => item.textContent === game.name)?.classList.add('selected');

        document.getElementById('status').textContent = ` Jeu s√©lectionn√©: ${game.name}`;
        document.getElementById('status').className = "info";
    }

    async function getAchievements(steamId, appId) {
        try {
            document.getElementById('status').textContent = `Chargement des succ√®s...`;
            document.getElementById('status').className = "info loading";

            const result = await window.steamAPI.getAchievements(steamId, appId);
            console.log('R√©sultat re√ßu:', result);

            if (!result || !result.achievements || result.achievements.length === 0) {
                document.getElementById('achievements').innerHTML = `<p class="no-data">Aucun succ√®s trouv√© pour ce jeu.</p>`;
                document.getElementById('achievements-container').style.display = 'none';
                document.getElementById('filter-container').style.display = 'none';
                document.getElementById('status').textContent = "Aucun succ√®s trouv√©";
                document.getElementById('status').className = "warning";
                return;
            }

            currentResult = result;
            currentAchievements = result.achievements;

            updateStats();

            document.getElementById('achievements-container').style.display = 'block';
            document.getElementById('filter-container').style.display = 'block';

            renderAchievements();

            document.getElementById('status').textContent = ` ${result.total} succ√®s charg√©s pour ${selectedGame.name}`;
            document.getElementById('status').className = "info";

        } catch (error) {
            console.error(' Erreur r√©cup√©ration succ√®s:', error);
            document.getElementById('achievements').innerHTML = `<p class="no-data">Erreur lors de la r√©cup√©ration des succ√®s.</p>`;
            document.getElementById('achievements-container').style.display = 'none';
            document.getElementById('filter-container').style.display = 'none';
            document.getElementById('status').textContent = " Erreur lors du chargement des succ√®s";
            document.getElementById('status').className = "error";
        }
    }

    function updateStats() {
        if (!currentResult) return;

        document.getElementById('game-title').textContent = ` Succ√®s de ${selectedGame.name}`;

        document.getElementById('total-achievements').textContent = currentResult.total || 0;
        document.getElementById('unlocked-achievements').textContent = currentResult.unlocked || 0;
        document.getElementById('percentage-achievements').textContent = `${currentResult.percentage || 0}%`;

        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const percentage = currentResult.percentage || 0;

        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}%`;

        const unlocked = currentAchievements.filter(a => a.unlocked || a.achieved).length;
        const locked = currentAchievements.length - unlocked;

        document.getElementById('filter-all').textContent = currentAchievements.length;
        document.getElementById('filter-unlocked').textContent = unlocked;
        document.getElementById('filter-locked').textContent = locked;
    }

    function renderAchievements() {
        const container = document.getElementById('achievements');
        container.innerHTML = '';

        const filteredAchievements = currentAchievements.filter(ach => {
            const isUnlocked = ach.unlocked || ach.achieved;
            if (filterMode === 'all') return true;
            if (filterMode === 'unlocked') return isUnlocked;
            if (filterMode === 'locked') return !isUnlocked;
            return true;
        });

        if (filteredAchievements.length === 0) {
            container.innerHTML = '<p class="no-data">Aucun succ√®s √† afficher selon le filtre.</p>';
            return;
        }

        filteredAchievements.forEach(ach => {
            const isUnlocked = ach.unlocked || ach.achieved;
            const div = document.createElement('div');
            div.className = `achievement ${isUnlocked ? '' : 'locked'}`;
            div.style.cssText = `
                background: ${isUnlocked ? 'rgba(26, 46, 26, 0.8)' : 'rgba(42, 45, 49, 0.6)'};
                border: 1px solid ${isUnlocked ? 'rgba(76, 175, 80, 0.5)' : 'rgba(255, 255, 255, 0.1)'};
                border-radius: 12px;
                padding: 15px;
                display: flex;
                align-items: center;
                gap: 15px;
                transition: all 0.3s;
            `;

            const unlockDate = isUnlocked && ach.unlockTime
                ? new Date(ach.unlockTime * 1000).toLocaleDateString('fr-FR')
                : '';

            div.innerHTML = `
                <div class="achievement-icon" style="
                    width: 50px;
                    height: 50px;
                    font-size: 28px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    background: ${isUnlocked ? 'rgba(76, 175, 80, 0.2)' : 'rgba(102, 102, 102, 0.2)'};
                ">${isUnlocked ? 'üèÜ' : 'üîí'}</div>
                <div class="achievement-info" style="flex: 1;">
                    <h4 style="margin: 0 0 5px 0; color: ${isUnlocked ? '#4CAF50' : '#999'};">
                        ${ach.name || ach.displayName || ach.id}
                    </h4>
                    <p style="margin: 5px 0; color: #aaa; font-size: 14px;">
                        ${ach.description || 'Pas de description'}
                    </p>
                    ${isUnlocked && unlockDate ? `<small style="color: #4CAF50;">D√©bloqu√© le ${unlockDate}</small>` : ''}
                    ${ach.globalPercentage ? `<small style="color: #888; display: block;">Raret√©: ${ach.globalPercentage.toFixed(1)}% des joueurs</small>` : ''}
                </div>
            `;

            container.appendChild(div);
        });
    }

    function setFilter(mode, event) {
        filterMode = mode;

        document.querySelectorAll('.filter-buttons button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        renderAchievements();
    }

    function testSelectedGame() {
        if (!selectedGame || !selectedUser) {
            alert(" Veuillez s√©lectionner un utilisateur et un jeu.");
            return;
        }
        getAchievements(selectedUser.steamId, selectedGame.appid);
    }

    function watchSelectedGame() {
        if (!selectedGame || !selectedUser) {
            alert(" Veuillez s√©lectionner un utilisateur et un jeu.");
            return;
        }

        window.steamAPI.startWatching(selectedUser.steamId, selectedGame.appid).then(result => {
            if (result.success) {
                document.getElementById('status').textContent = ` Surveillance activ√©e pour ${selectedGame.name}`;
                document.getElementById('status').className = "info";

                // √âcouter les mises √† jour
                window.steamAPI.onAchievementUnlocked((data) => {
                    if (data.gameId === selectedGame.appid) {
                        console.log(' Nouveaux succ√®s d√©tect√©s!');
                        currentResult = data;
                        currentAchievements = data.achievements;
                        updateStats();
                        renderAchievements();

                        // Notification
                        const notification = document.createElement('div');
                        notification.className = 'notification-popup';
                        notification.innerHTML = `
                            <div class="notification-content">
                                <div style="font-size: 36px; margin-right: 15px;">üèÜ</div>
                                <div>
                                    <strong>Nouveau succ√®s d√©bloqu√©!</strong>
                                    <p>${selectedGame.name}</p>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(notification);

                        setTimeout(() => notification.remove(), 5000);
                    }
                });
            }
        }).catch(err => {
            console.error('Erreur surveillance:', err);
            document.getElementById('status').textContent = " Erreur lors de l'activation de la surveillance";
            document.getElementById('status').className = "error";
        });
    }

    function showGames() {
        document.getElementById('achievements').innerHTML = '';
        document.getElementById('achievements-container').style.display = 'none';
        document.getElementById('filter-container').style.display = 'none';
        document.getElementById('game-selection').style.display = 'block';
        document.getElementById('controls').style.display = 'block';
        document.getElementById('status').textContent = ' Choisissez un jeu';
        document.getElementById('status').className = "info";
    }

    function changeUser() {
        selectedUser = null;
        selectedGame = null;
        userGames = [];
        currentAchievements = [];
        currentResult = null;
        filterMode = 'all';

        document.getElementById('user-selection').style.display = 'block';
        document.getElementById('game-selection').style.display = 'none';
        document.getElementById('controls').style.display = 'none';
        document.getElementById('achievements-container').style.display = 'none';
        document.getElementById('filter-container').style.display = 'none';
        document.getElementById('achievements').innerHTML = '';
        document.getElementById('start-btn').disabled = true;
        document.getElementById('start-btn').setAttribute('aria-disabled', 'true');

        // R√©initialiser les filtres
        document.querySelectorAll('.filter-buttons button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.filter-buttons button').classList.add('active');

        displayUsers();
        document.getElementById('status').textContent = ' S√©lectionnez votre compte Steam';
        document.getElementById('status').className = "info";
    }

    window.onload = init;
</script>

</body>
</html>