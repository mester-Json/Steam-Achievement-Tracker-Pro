<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./renderer/style.css" />
    <title>Steam Achievement Tracker Pro</title>
    <style>
        .friends-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .friend-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #4CAF50;
        }

        .friend-item.selected {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: bold;
            color: #fff;
            margin: 0;
        }

        .friend-status {
            font-size: 12px;
            color: #888;
            margin: 2px 0 0 0;
        }

        .friend-game {
            font-size: 11px;
            color: #4CAF50;
            margin: 2px 0 0 0;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .player-stats {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .player-stats h4 {
            margin: 0 0 15px 0;
            color: #4CAF50;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            margin: 10px 0;
        }

        .comparison-achievement {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid transparent;
        }

        .comparison-achievement.both {
            border-left-color: #4CAF50;
        }

        .comparison-achievement.player1_only {
            border-left-color: #2196F3;
        }

        .comparison-achievement.player2_only {
            border-left-color: #FF9800;
        }

        .comparison-achievement.neither {
            border-left-color: #666;
        }

        .achievement-players {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }

        .player-achievement {
            text-align: center;
            min-width: 80px;
        }

        .player-achievement.achieved {
            color: #4CAF50;
        }

        .player-achievement.not-achieved {
            color: #666;
        }

        .comparison-filters {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .comparison-filters button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .comparison-filters button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .comparison-filters button:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .tab-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .tab-button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .tab-button:hover:not(.active) {
            background: rgba(76, 175, 80, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .friends-loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .no-friends {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .winner-badge {
            background: #FFD700;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .common-game-item {
            transition: transform 0.2s ease;
        }

        .common-game-item:hover {
            transform: translateY(-2px);
        }

        .common-game-item button:hover {
            background: #45a049 !important;
        }
    </style>
</head>
<body>
<h1> Steam Achievement Tracker Pro</h1>

<div id="status" class="info">Initialisation...</div>

<section id="user-selection" class="user-selector" style="display: none;">
    <h2> Sélectionnez votre profil Steam</h2>
    <div id="user-list" role="list" aria-label="Liste des utilisateurs Steam"></div>
    <div style="text-align: center; margin-top: 25px;">
        <button id="start-btn" onclick="startTracking()" disabled aria-disabled="true"> Démarrer</button>
    </div>
</section>

<div id="main-interface" style="display: none;">
    <!-- Onglets principaux -->
    <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('games')"> Mes Jeux</button>
        <button class="tab-button" onclick="switchTab('friends')"> Amis</button>
        <button class="tab-button" onclick="switchTab('comparison')" id="comparison-tab" style="display: none;"> Comparaison</button>
    </div>

    <div id="controls" style="margin-bottom: 20px;">
        <button onclick="changeUser()"> Changer d'utilisateur</button>
    </div>

    <!-- Onglet Jeux -->
    <div id="games-tab" class="tab-content active">
        <section id="game-selection" class="user-selector">
            <h2> Sélectionnez un jeu</h2>
            <div id="game-list" class="game-list" role="list" aria-label="Liste des jeux"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="testSelectedGame()"> Voir les succès</button>
                <button onclick="watchSelectedGame()">Surveiller ce jeu</button>
            </div>
        </section>

        <div id="achievements-container" class="achievements-header" style="display: none;">
            <h3 id="game-title"> Succès</h3>

            <div class="progress-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                <div class="stat-box" style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; text-align: center;">
                    <h4 style="color: #888; font-size: 0.9rem; margin-bottom: 5px; font-weight: normal;">Total</h4>
                    <p id="total-achievements" style="font-size: 1.8rem; font-weight: bold; color: #4CAF50; margin: 0;">0</p>
                </div>
                <div class="stat-box" style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; text-align: center;">
                    <h4 style="color: #888; font-size: 0.9rem; margin-bottom: 5px; font-weight: normal;">Débloqués</h4>
                    <p id="unlocked-achievements" style="font-size: 1.8rem; font-weight: bold; color: #4CAF50; margin: 0;">0</p>
                </div>
                <div class="stat-box" style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; text-align: center;">
                    <h4 style="color: #888; font-size: 0.9rem; margin-bottom: 5px; font-weight: normal;">Progression</h4>
                    <p id="percentage-achievements" style="font-size: 1.8rem; font-weight: bold; color: #4CAF50; margin: 0;">0%</p>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%">
                    <span id="progress-text">0%</span>
                </div>
            </div>
        </div>

        <div class="filter-buttons" id="filter-container" style="display: none;">
            <button class="active" onclick="setFilter('all', event)">Tous (<span id="filter-all">0</span>)</button>
            <button onclick="setFilter('unlocked', event)">Débloqués (<span id="filter-unlocked">0</span>)</button>
            <button onclick="setFilter('locked', event)">Verrouillés (<span id="filter-locked">0</span>)</button>
        </div>

        <div id="achievements" class="achievement-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;" role="list" aria-label="Liste des succès"></div>
    </div>

    <!-- Onglet Amis -->
    <div id="friends-tab" class="tab-content">
        <div class="friends-section">
            <h2> Liste d'amis Steam</h2>
            <div id="friends-loading" class="friends-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Chargement de la liste d'amis...</p>
            </div>
            <div id="friends-list"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="loadFriends()" id="load-friends-btn"> Charger mes amis</button>
                <button onclick="compareFriendAchievements()" id="compare-friend-btn" disabled> Comparer les succès</button>
            </div>
        </div>
    </div>

    <!-- Onglet Comparaison -->
    <div id="comparison-tab-content" class="tab-content">
        <div id="comparison-container" style="display: none;">
            <h2>⚔️ Comparaison des succès</h2>
            <div id="comparison-header"></div>

            <div class="comparison-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div class="player-stats">
                    <h4> Vous</h4>
                    <div class="stat-value" id="player1-total">0</div>
                    <div style="color: #888;">succès débloqués</div>
                    <div style="color: #4CAF50; font-weight: bold;" id="player1-percentage">0%</div>
                </div>
                <div class="player-stats">
                    <h4> <span id="friend-name">Ami</span></h4>
                    <div class="stat-value" id="player2-total">0</div>
                    <div style="color: #888;">succès débloqués</div>
                    <div style="color: #4CAF50; font-weight: bold;" id="player2-percentage">0%</div>
                </div>
            </div>

            <div class="comparison-filters">
                <button class="active" onclick="setComparisonFilter('all', event)">Tous (<span id="comp-filter-all">0</span>)</button>
                <button onclick="setComparisonFilter('both', event)">Communs (<span id="comp-filter-both">0</span>)</button>
                <button onclick="setComparisonFilter('player1_only', event)">Vous uniquement (<span id="comp-filter-player1">0</span>)</button>
                <button onclick="setComparisonFilter('player2_only', event)">Ami uniquement (<span id="comp-filter-player2">0</span>)</button>
                <button onclick="setComparisonFilter('neither', event)">Aucun (<span id="comp-filter-neither">0</span>)</button>
            </div>

            <div id="comparison-achievements"></div>
        </div>
    </div>
</div>

<script>
    let selectedUser = null;
    let selectedGame = null;
    let selectedFriend = null;
    let steamUsers = [];
    let userGames = [];
    let friendsList = [];
    let currentAchievements = [];
    let currentResult = null;
    let currentComparison = null;
    let filterMode = 'all';
    let comparisonFilter = 'all';

    async function init() {
        console.log(' Initialisation...');
        const status = document.getElementById('status');

        if (!window.steamAPI) {
            status.textContent = " API Steam non disponible !";
            status.className = "error";
            return;
        }

        status.textContent = " API Steam détectée, recherche de Steam...";
        status.className = "info";

        try {
            const steamPath = await window.steamAPI.getSteamPath();
            console.log(' Chemin Steam:', steamPath);

            if (!steamPath) {
                status.textContent = " Steam non trouvé !";
                status.className = "error";
                return;
            }

            const pathParts = steamPath.split(/[\\/]/);
            const steamFolder = pathParts[pathParts.length - 1];
            status.textContent = ` Steam trouvé: ${steamFolder}`;
            status.className = "info";

            const result = await window.steamAPI.getSteamUsers();
            console.log(' Utilisateurs Steam:', result);

            if (!result.users || result.users.length === 0) {
                status.textContent = " Aucun compte Steam détecté.";
                status.className = "warning";
                return;
            }

            steamUsers = result.users;
            displayUsers();

        } catch (error) {
            console.error(' Erreur init:', error);
            status.textContent = ` Erreur: ${error.message}`;
            status.className = "error";
        }
    }

    function displayUsers() {
        const userSelection = document.getElementById('user-selection');
        const userList = document.getElementById('user-list');

        userList.innerHTML = '';

        steamUsers.forEach((user, index) => {
            const card = document.createElement('div');
            card.className = 'user-card';
            card.setAttribute('role', 'listitem');
            card.tabIndex = 0;
            card.onclick = (event) => selectUser(user, event);
            card.onkeypress = (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    selectUser(user, event);
                    event.preventDefault();
                }
            };

            const displayName = user.personaName || user.accountName || `Utilisateur ${index + 1}`;

            const avatarSvg = `<svg class="user-avatar" viewBox="0 0 24 24" fill="#4CAF50" style="width: 60px; height: 60px;">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>`;

            card.innerHTML = `
                ${avatarSvg}
                <div class="user-info">
                    <h3>${displayName}</h3>
                    <p>@${user.accountName || 'N/A'} ${user.mostRecent ? '(Récent)' : ''}</p>
                    <small>Steam ID: ${user.steamId || 'N/A'}</small>
                </div>
            `;
            userList.appendChild(card);
        });

        userSelection.style.display = 'block';
        document.getElementById('status').textContent = " Sélectionnez votre compte Steam";
        document.getElementById('status').className = "info";
    }

    function selectUser(user, event) {
        selectedUser = user;

        const cards = document.querySelectorAll('.user-card');
        cards.forEach(card => card.classList.remove('selected'));
        event.currentTarget.classList.add('selected');

        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = false;
        startBtn.setAttribute('aria-disabled', 'false');

        document.getElementById('status').textContent = ` Compte sélectionné: ${user.personaName || user.accountName}`;
        document.getElementById('status').className = "info";
    }

    async function startTracking() {
        if (!selectedUser) return;

        document.getElementById('user-selection').style.display = 'none';
        document.getElementById('main-interface').style.display = 'block';
        document.getElementById('status').textContent = ` Chargement des jeux de ${selectedUser.personaName || selectedUser.accountName}...`;
        document.getElementById('status').className = "info loading";

        try {
            const games = await window.steamAPI.getUserGames(selectedUser.steamId);
            userGames = games || [];

            if (userGames.length === 0) {
                document.getElementById('status').textContent = " Aucun jeu détecté pour cet utilisateur.";
                document.getElementById('status').className = "warning";
                return;
            }

            displayGames();
            document.getElementById('status').textContent = ` ${userGames.length} jeux chargés pour ${selectedUser.personaName || selectedUser.accountName}`;
            document.getElementById('status').className = "info";

        } catch (error) {
            console.error(' Erreur récupération jeux:', error);
            document.getElementById('status').textContent = ` Erreur lors du chargement des jeux: ${error.message}`;
            document.getElementById('status').className = "error";
        }
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });

        document.getElementById(`${tab}-tab`).classList.add('active');
        document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');

        if (tab === 'friends' && friendsList.length === 0) {
            // loadFriends();
        }
    }

    async function loadFriends() {
        if (!selectedUser) {
            alert(" Aucun utilisateur sélectionné");
            return;
        }

        const loadingDiv = document.getElementById('friends-loading');
        const friendsListDiv = document.getElementById('friends-list');
        const loadBtn = document.getElementById('load-friends-btn');

        loadingDiv.style.display = 'block';
        loadBtn.disabled = true;
        document.getElementById('status').textContent = " Chargement de la liste d'amis...";
        document.getElementById('status').className = "info loading";

        try {
            const friends = await window.steamAPI.getFriendsList(selectedUser.steamId);
            friendsList = friends || [];

            loadingDiv.style.display = 'none';
            loadBtn.disabled = false;

            if (friendsList.length === 0) {
                friendsListDiv.innerHTML = '<div class="no-friends">Aucun ami trouvé ou liste privée</div>';
                document.getElementById('status').textContent = "️ Aucun ami trouvé";
                document.getElementById('status').className = "warning";
                return;
            }

            displayFriends();
            document.getElementById('status').textContent = `👥 ${friendsList.length} amis chargés`;
            document.getElementById('status').className = "info";

        } catch (error) {
            console.error(' Erreur chargement amis:', error);
            loadingDiv.style.display = 'none';
            loadBtn.disabled = false;
            friendsListDiv.innerHTML = '<div class="no-friends"> Erreur lors du chargement des amis</div>';
            document.getElementById('status').textContent = " Erreur chargement amis";
            document.getElementById('status').className = "error";
        }
    }

    function displayFriends() {
        const friendsListDiv = document.getElementById('friends-list');
        friendsListDiv.innerHTML = '';

        friendsList.forEach(friend => {
            const friendDiv = document.createElement('div');
            friendDiv.className = 'friend-item';
            friendDiv.onclick = (event) => selectFriend(friend, event);

            const statusText = getPersonaStateText(friend.personaState);
            const gameText = friend.gameExtraInfo ? ` ${friend.gameExtraInfo}` : '';

            friendDiv.innerHTML = `
                <img src="${friend.avatar}" alt="Avatar" class="friend-avatar" onerror="this.style.display='none'">
                <div class="friend-info">
                    <h4 class="friend-name">${friend.personaName}</h4>
                    <p class="friend-status">${statusText}</p>
                    ${gameText ? `<p class="friend-game">${gameText}</p>` : ''}
                </div>
            `;

            friendsListDiv.appendChild(friendDiv);
        });
    }

    function selectFriend(friend, event) {
        selectedFriend = friend;

        document.querySelectorAll('.friend-item').forEach(item => {
            item.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');

        document.getElementById('compare-friend-btn').disabled = false;

        document.getElementById('status').textContent = ` Ami sélectionné: ${friend.personaName}`;
        document.getElementById('status').className = "info";

        loadFriendGames(friend.steamId);
    }

    async function loadFriendGames(friendSteamId) {
        try {
            document.getElementById('status').textContent = ` Chargement des jeux de ${selectedFriend.personaName}...`;
            document.getElementById('status').className = "info loading";

            const friendGames = await window.steamAPI.getUserGames(friendSteamId);

            if (!friendGames || friendGames.length === 0) {
                document.getElementById('status').textContent = ` Impossible de récupérer les jeux de ${selectedFriend.personaName} (profil privé?)`;
                document.getElementById('status').className = "warning";
                return;
            }

            // Trouver les jeux en commun
            const commonGames = userGames.filter(myGame =>
                friendGames.some(friendGame => friendGame.appid === myGame.appid)
            );

            displayCommonGames(commonGames, friendGames.length);

            document.getElementById('status').textContent = `🎮 ${commonGames.length} jeux en commun trouvés avec ${selectedFriend.personaName}`;
            document.getElementById('status').className = "info";

        } catch (error) {
            console.error(' Erreur chargement jeux ami:', error);
            document.getElementById('status').textContent = ` Erreur lors du chargement des jeux de ${selectedFriend.personaName}`;
            document.getElementById('status').className = "error";
        }
    }

    function displayCommonGames(commonGames, totalFriendGames) {
        let commonGamesSection = document.getElementById('common-games-section');

        if (!commonGamesSection) {
            commonGamesSection = document.createElement('div');
            commonGamesSection.id = 'common-games-section';
            commonGamesSection.className = 'friends-section';

            const friendsSection = document.querySelector('.friends-section');
            friendsSection.parentNode.insertBefore(commonGamesSection, friendsSection.nextSibling);
        }

        commonGamesSection.innerHTML = `
            <h3> Jeux en commun avec ${selectedFriend.personaName}</h3>
            <p style="color: #888; margin-bottom: 15px;">
                ${commonGames.length} jeux en commun sur ${totalFriendGames} jeux total
                ${commonGames.length > 0 ? '- Cliquez sur un jeu pour le comparer' : ''}
            </p>
            <div id="common-games-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                ${commonGames.length === 0 ?
            '<p style="color: #888; text-align: center; grid-column: 1 / -1;"> Aucun jeu en commun trouvé</p>' :
            commonGames.map(game => `
                        <div class="common-game-item" onclick="selectGameForComparison('${game.appid}', '${game.name.replace(/'/g, "\\'")}')"
                             style="
                                 background: rgba(255, 255, 255, 0.05);
                                 border: 1px solid rgba(255, 255, 255, 0.1);
                                 border-radius: 8px;
                                 padding: 12px;
                                 cursor: pointer;
                                 transition: all 0.3s;
                                 text-align: center;
                             "
                             onmouseover="this.style.background='rgba(76, 175, 80, 0.1)'; this.style.borderColor='#4CAF50'"
                             onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'">
                            <div style="font-weight: bold; color: #fff; margin-bottom: 5px;">${game.name}</div>
                            <div style="font-size: 12px; color: #888;">
                                ${game.playtime ? `${Math.round(game.playtime / 60)}h jouées` : 'Temps de jeu inconnu'}
                            </div>
                            <div style="margin-top: 8px;">
                                <button style="
                                    background: #4CAF50;
                                    border: none;
                                    color: white;
                                    padding: 6px 12px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 12px;
                                ">️ Comparer</button>
                            </div>
                        </div>
                    `).join('')
        }
            </div>
        `;
    }

    function selectGameForComparison(appid, gameName) {
        selectedGame = {
            appid: appid,
            name: gameName.replace(/\\'/g, "'")
        };

        console.log(' Jeu sélectionné pour comparaison:', selectedGame);

        document.getElementById('status').textContent = ` Jeu sélectionné pour comparaison: ${selectedGame.name}`;
        document.getElementById('status').className = "info";

        setTimeout(() => {
            compareFriendAchievements();
        }, 100);
    }

    function getPersonaStateText(state) {
        const states = {
            0: ' Hors ligne',
            1: ' En ligne',
            2: ' Occupé',
            3: ' Absent',
            4: ' Endormi',
            5: ' Cherche à échanger',
            6: ' Cherche à jouer'
        };
        return states[state] || ' Inconnu';
    }

    async function compareFriendAchievements() {
        console.log(' État des sélections:');
        console.log('  selectedUser:', selectedUser);
        console.log('  selectedFriend:', selectedFriend);
        console.log('  selectedGame:', selectedGame);

        if (!selectedUser) {
            alert("️ Veuillez d'abord sélectionner un utilisateur Steam");
            return;
        }

        if (!selectedFriend) {
            alert("️ Veuillez d'abord sélectionner un ami dans la liste");
            return;
        }

        if (!selectedGame) {
            alert(" Veuillez d'abord sélectionner un jeu dans l'onglet 'Mes Jeux'");
            return;
        }

        document.getElementById('status').textContent = " Comparaison des succès en cours...";
        document.getElementById('status').className = "info loading";

        try {
            console.log(' Lancement de la comparaison avec:');
            console.log('  SteamID utilisateur:', selectedUser.steamId);
            console.log('  SteamID ami:', selectedFriend.steamId);
            console.log('  App ID jeu:', selectedGame.appid);
            console.log('  Nom du jeu:', selectedGame.name);

            const comparison = await window.steamAPI.compareAchievements(
                selectedUser.steamId,
                selectedFriend.steamId,
                selectedGame.appid
            );

            console.log(' Résultat de la comparaison:', comparison);

            if (!comparison) {
                document.getElementById('status').textContent = " Impossible de comparer les succès (jeu non supporté ou erreur API)";
                document.getElementById('status').className = "error";
                return;
            }

            if (comparison.error) {
                document.getElementById('status').textContent = `${comparison.error}`;
                document.getElementById('status').className = "error";
                return;
            }

            currentComparison = comparison;
            displayComparison();

            document.getElementById('comparison-tab').style.display = 'block';
            switchTab('comparison');

            document.getElementById('status').textContent = `️ Comparaison terminée pour ${selectedGame.name}`;
            document.getElementById('status').className = "info";

        } catch (error) {
            console.error(' Erreur comparaison:', error);
            document.getElementById('status').textContent = ` Erreur lors de la comparaison: ${error.message}`;
            document.getElementById('status').className = "error";
        }
    }

    function displayComparison() {
        if (!currentComparison) {
            console.error('currentComparison est null ou undefined');
            return;
        }

        console.log(' Affichage de la comparaison:', currentComparison);
        console.log('  player1:', currentComparison.player1);
        console.log('  player2:', currentComparison.player2);
        console.log('  achievements length:', currentComparison.achievements?.length);
        console.log('  stats:', currentComparison.stats);

        document.getElementById('comparison-container').style.display = 'block';

        const player1Data = currentComparison.player1 || {};
        const player2Data = currentComparison.player2 || {};
        const stats = currentComparison.stats || {};

        const player1Total = player1Data.unlockedCount || 0;
        const player1Percentage = player1Data.percentage || 0;
        const player2Total = player2Data.unlockedCount || 0;
        const player2Percentage = player2Data.percentage || 0;

        console.log(' Statistiques calculées:');
        console.log('  Player1 - Total:', player1Total, 'Percentage:', player1Percentage);
        console.log('  Player2 - Total:', player2Total, 'Percentage:', player2Percentage);

        document.getElementById('player1-total').textContent = player1Total;
        document.getElementById('player1-percentage').textContent = `${player1Percentage}%`;

        document.getElementById('player2-total').textContent = player2Total;
        document.getElementById('player2-percentage').textContent = `${player2Percentage}%`;

        document.getElementById('friend-name').textContent = selectedFriend?.personaName || 'Ami';

        const player1Stats = document.querySelector('.player-stats:first-child h4');
        const player2Stats = document.querySelector('.player-stats:last-child h4');

        player1Stats.querySelector('.winner-badge')?.remove();
        player2Stats.querySelector('.winner-badge')?.remove();

        if (player1Percentage > player2Percentage) {
            player1Stats.innerHTML += '<span class="winner-badge"> Gagnant</span>';
        } else if (player2Percentage > player1Percentage) {
            player2Stats.innerHTML += '<span class="winner-badge"> Gagnant</span>';
        }

        const achievementsLength = currentComparison.achievements?.length || 0;
        const bothUnlocked = stats.bothUnlocked || 0;
        const player1Only = stats.player1Only || 0;
        const player2Only = stats.player2Only || 0;
        const neitherUnlocked = stats.neitherUnlocked || 0;

        console.log(' Compteurs de filtres:');
        console.log('  Total:', achievementsLength);
        console.log('  Both:', bothUnlocked);
        console.log('  Player1 only:', player1Only);
        console.log('  Player2 only:', player2Only);
        console.log('  Neither:', neitherUnlocked);

        document.getElementById('comp-filter-all').textContent = achievementsLength;
        document.getElementById('comp-filter-both').textContent = bothUnlocked;
        document.getElementById('comp-filter-player1').textContent = player1Only;
        document.getElementById('comp-filter-player2').textContent = player2Only;
        document.getElementById('comp-filter-neither').textContent = neitherUnlocked;

        renderComparisonAchievements();
    }

    function renderComparisonAchievements() {
        console.log(' renderComparisonAchievements appelé');
        console.log('  currentComparison:', currentComparison);
        console.log('  comparisonFilter:', comparisonFilter);

        const container = document.getElementById('comparison-achievements');

        if (!currentComparison || !currentComparison.achievements) {
            console.error(' Pas de données de comparaison ou achievements manquants');
            container.innerHTML = '<p class="no-data"> Erreur: données de comparaison manquantes</p>';
            return;
        }

        const achievements = currentComparison.achievements;
        console.log(' Nombre total d\'achievements:', achievements.length);

        const filteredAchievements = achievements.filter(ach => {
            if (comparisonFilter === 'all') return true;
            return ach.status === comparisonFilter;
        });

        console.log(' Achievements après filtrage:', filteredAchievements.length);

        if (filteredAchievements.length === 0) {
            container.innerHTML = '<p class="no-data">Aucun succès à afficher selon le filtre.</p>';
            return;
        }

        const formatDate = (timestamp) => {
            if (!timestamp) return 'Non débloqué';
            return new Date(timestamp * 1000).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        };

        const getPlayerIcon = (achieved) => achieved ? '🏆' : '🔒';
        const getPlayerClass = (achieved) => achieved ? 'achieved' : 'not-achieved';

        console.log('Construction de l\'HTML pour', filteredAchievements.length, 'achievements');

        container.innerHTML = '';

        filteredAchievements.forEach((ach, index) => {
            if (index < 3) { // Log des 3 premiers pour debug
                console.log(` Achievement ${index + 1}:`, ach);
            }

            const div = document.createElement('div');
            div.className = `comparison-achievement ${ach.status || 'unknown'}`;

            const achievementName = ach.name || ach.apiname || 'Succès inconnu';
            const achievementDesc = ach.description || 'Pas de description';

            div.innerHTML = `
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 5px 0; color: #fff;">
                        ${achievementName}
                    </h4>
                    <p style="margin: 5px 0; color: #aaa; font-size: 14px;">
                        ${achievementDesc}
                    </p>
                    ${ach.percentage ? `<small style="color: #888;">Rareté: ${ach.percentage.toFixed(1)}% des joueurs</small>` : ''}
                </div>
                <div class="achievement-players">
                    <div class="player-achievement ${getPlayerClass(ach.player1?.achieved)}">
                        <div style="font-size: 20px;">${getPlayerIcon(ach.player1?.achieved)}</div>
                        <div style="font-size: 11px;">Vous</div>
                        <div style="font-size: 10px;">${formatDate(ach.player1?.unlockTime)}</div>
                        ${ach.status === 'both' && ach.firstUnlock === 'player1' ? '<div style="color: #FFD700; font-size: 10px;"> Premier</div>' : ''}
                    </div>
                    <div class="player-achievement ${getPlayerClass(ach.player2?.achieved)}">
                        <div style="font-size: 20px;">${getPlayerIcon(ach.player2?.achieved)}</div>
                        <div style="font-size: 11px;">Ami</div>
                        <div style="font-size: 10px;">${formatDate(ach.player2?.unlockTime)}</div>
                        ${ach.status === 'both' && ach.firstUnlock === 'player2' ? '<div style="color: #FFD700; font-size: 10px;"> Premier</div>' : ''}
                    </div>
                </div>
            `;

            container.appendChild(div);
        });

        console.log(' Rendu terminé:', container.children.length, 'éléments ajoutés');
    }

    function setComparisonFilter(mode, event) {
        comparisonFilter = mode;

        document.querySelectorAll('.comparison-filters button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        renderComparisonAchievements();
    }

    function displayGames() {
        const gameSelection = document.getElementById('game-selection');
        const gameList = document.getElementById('game-list');
        gameList.innerHTML = '';

        userGames.forEach(game => {
            const div = document.createElement('div');
            div.className = 'game-item';
            div.setAttribute('role', 'listitem');
            div.tabIndex = 0;
            div.textContent = game.name;
            div.onclick = () => selectGame(game);
            div.onkeypress = (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    selectGame(game);
                    e.preventDefault();
                }
            };
            gameList.appendChild(div);
        });

        gameSelection.style.display = 'block';
        document.getElementById('status').textContent = ' Sélectionnez un jeu';
        document.getElementById('status').className = "info";
    }

    function selectGame(game) {
        selectedGame = game;

        const gameItems = document.querySelectorAll('.game-item');
        gameItems.forEach(item => item.classList.remove('selected'));

        [...gameItems].find(item => item.textContent === game.name)?.classList.add('selected');

        document.getElementById('status').textContent = ` Jeu sélectionné: ${game.name}`;
        document.getElementById('status').className = "info";
    }

    async function getAchievements(steamId, appId) {
        try {
            document.getElementById('status').textContent = ` Chargement des succès ...`;
            document.getElementById('status').className = "info loading";

            const result = await window.steamAPI.getAchievements(steamId, appId);
            console.log('Résultat reçu:', result);

            if (!result || !result.achievements || result.achievements.length === 0) {
                document.getElementById('achievements').innerHTML = `<p class="no-data">Aucun succès trouvé pour ce jeu.</p>`;
                document.getElementById('achievements-container').style.display = 'none';
                document.getElementById('filter-container').style.display = 'none';
                document.getElementById('status').textContent = " Aucun succès trouvé";
                document.getElementById('status').className = "warning";
                return;
            }

            currentResult = result;
            currentAchievements = result.achievements;

            updateStats();

            document.getElementById('achievements-container').style.display = 'block';
            document.getElementById('filter-container').style.display = 'block';

            renderAchievements();

            document.getElementById('status').textContent = ` ${result.total} succès chargés pour ${selectedGame.name}`;
            document.getElementById('status').className = "info";

        } catch (error) {
            console.error('Erreur récupération succès:', error);
            document.getElementById('achievements').innerHTML = `<p class="no-data">Erreur lors de la récupération des succès.</p>`;
            document.getElementById('achievements-container').style.display = 'none';
            document.getElementById('filter-container').style.display = 'none';
            document.getElementById('status').textContent = " Erreur lors du chargement des succès";
            document.getElementById('status').className = "error";
        }
    }

    function updateStats() {
        if (!currentResult) return;

        document.getElementById('game-title').textContent = ` Succès de ${selectedGame.name}`;

        document.getElementById('total-achievements').textContent = currentResult.total || 0;
        document.getElementById('unlocked-achievements').textContent = currentResult.unlocked || 0;
        document.getElementById('percentage-achievements').textContent = `${currentResult.percentage || 0}%`;

        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const percentage = currentResult.percentage || 0;

        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}%`;

        const unlocked = currentAchievements.filter(a => a.unlocked || a.achieved).length;
        const locked = currentAchievements.length - unlocked;

        document.getElementById('filter-all').textContent = currentAchievements.length;
        document.getElementById('filter-unlocked').textContent = unlocked;
        document.getElementById('filter-locked').textContent = locked;
    }

    function renderAchievements() {
        const container = document.getElementById('achievements');
        container.innerHTML = '';

        const filteredAchievements = currentAchievements.filter(ach => {
            const isUnlocked = ach.unlocked || ach.achieved;
            if (filterMode === 'all') return true;
            if (filterMode === 'unlocked') return isUnlocked;
            if (filterMode === 'locked') return !isUnlocked;
            return true;
        });

        if (filteredAchievements.length === 0) {
            container.innerHTML = '<p class="no-data">Aucun succès à afficher selon le filtre.</p>';
            return;
        }

        filteredAchievements.forEach(ach => {
            const isUnlocked = ach.unlocked || ach.achieved;
            const div = document.createElement('div');

            let achievementClass = 'achievement';
            let borderColor = 'rgba(255, 255, 255, 0.1)';
            let backgroundColor = 'rgba(42, 45, 49, 0.6)';

            if (isUnlocked) {
                if (ach.legitimacy) {
                    switch (ach.legitimacy.status) {
                        case 'cheated':
                            achievementClass += ' suspicious';
                            borderColor = 'rgba(244, 67, 54, 0.5)';
                            backgroundColor = 'rgba(49, 26, 26, 0.9)';
                            break;
                        case 'suspicious':
                            achievementClass += ' suspicious';
                            borderColor = 'rgba(255, 152, 0, 0.5)';
                            backgroundColor = 'rgba(49, 39, 26, 0.8)';
                            break;
                        default:
                            borderColor = 'rgba(76, 175, 80, 0.5)';
                            backgroundColor = 'rgba(26, 46, 26, 0.8)';
                    }
                } else {
                    borderColor = 'rgba(76, 175, 80, 0.5)';
                    backgroundColor = 'rgba(26, 46, 26, 0.8)';
                }
            } else {
                achievementClass += ' locked';
            }

            div.className = achievementClass;
            div.style.cssText = `
                background: ${backgroundColor};
                border: 1px solid ${borderColor};
                border-radius: 12px;
                padding: 15px;
                display: flex;
                align-items: center;
                gap: 15px;
                transition: all 0.3s;
                position: relative;
            `;

            const unlockDate = isUnlocked && ach.unlockTime
                ? new Date(ach.unlockTime * 1000).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                })
                : '';

            let icon = '🔒';
            let iconBg = 'rgba(102, 102, 102, 0.2)';
            if (isUnlocked) {
                if (ach.legitimacy?.status === 'cheated') {
                    icon = '🚫';
                    iconBg = 'rgba(244, 67, 54, 0.2)';
                } else if (ach.legitimacy?.status === 'suspicious') {
                    icon = '⚠️';
                    iconBg = 'rgba(255, 152, 0, 0.2)';
                } else {
                    icon = '🏆';
                    iconBg = 'rgba(76, 175, 80, 0.2)';
                }
            }

            div.innerHTML = `
                <div class="achievement-icon" style="
                    width: 50px;
                    height: 50px;
                    font-size: 28px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    background: ${iconBg};
                ">${icon}</div>
                <div class="achievement-info" style="flex: 1;">
                    <h4 style="margin: 0 0 5px 0; color: ${isUnlocked ? '#4CAF50' : '#999'};">
                        ${ach.name || ach.displayName || ach.id}
                    </h4>
                    <p style="margin: 5px 0; color: #aaa; font-size: 14px;">
                        ${ach.description || 'Pas de description'}
                    </p>
                    ${isUnlocked && unlockDate ? `<small style="color: #4CAF50;">Débloqué le ${unlockDate}</small>` : ''}
                    ${ach.globalPercentage ? `<small style="color: #888; display: block;">Rareté: ${ach.globalPercentage.toFixed(1)}% des joueurs</small>` : ''}
                    ${ach.legitimacy && ach.legitimacy.status !== 'legitimate' ? `
                        <small style="color: ${ach.legitimacy.status === 'cheated' ? '#f44336' : '#ff9800'}; display: block; margin-top: 5px;">
                             ${ach.legitimacy.issues.join(' • ')}
                        </small>
                    ` : ''}
                </div>
                ${ach.legitimacy && isUnlocked ? `
                    <div style="
                        position: absolute;
                        top: 5px;
                        right: 5px;
                        background: ${ach.legitimacy.status === 'cheated' ? '#f44336' : ach.legitimacy.status === 'suspicious' ? '#ff9800' : '#4CAF50'};
                        color: white;
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: bold;
                    ">
                        ${ach.legitimacy.score}%
                    </div>
                ` : ''}
            `;

            container.appendChild(div);
        });
    }

    function setFilter(mode, event) {
        filterMode = mode;

        document.querySelectorAll('.filter-buttons button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        renderAchievements();
    }

    function testSelectedGame() {
        if (!selectedGame || !selectedUser) {
            alert(" Veuillez sélectionner un utilisateur et un jeu.");
            return;
        }
        getAchievements(selectedUser.steamId, selectedGame.appid);
    }

    function watchSelectedGame() {
        if (!selectedGame || !selectedUser) {
            alert("Veuillez sélectionner un utilisateur et un jeu.");
            return;
        }

        window.steamAPI.startWatching(selectedUser.steamId, selectedGame.appid).then(result => {
            if (result.success) {
                document.getElementById('status').textContent = ` Surveillance activée pour ${selectedGame.name}`;
                document.getElementById('status').className = "info";

                window.steamAPI.onAchievementUnlocked((data) => {
                    if (data.gameId === selectedGame.appid) {
                        console.log(' Nouveaux succès détectés!');
                        currentResult = data;
                        currentAchievements = data.achievements;
                        updateStats();
                        renderAchievements();

                        const notification = document.createElement('div');
                        notification.className = 'notification-popup';
                        notification.innerHTML = `
                            <div class="notification-content">
                                <div style="font-size: 36px; margin-right: 15px;">🏆</div>
                                <div>
                                    <strong>Nouveau succès débloqué!</strong>
                                    <p>${selectedGame.name}</p>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(notification);

                        setTimeout(() => notification.remove(), 5000);
                    }
                });
            }
        }).catch(err => {
            console.error('Erreur surveillance:', err);
            document.getElementById('status').textContent = " Erreur lors de l'activation de la surveillance";
            document.getElementById('status').className = "error";
        });
    }

    function changeUser() {
        selectedUser = null;
        selectedGame = null;
        selectedFriend = null;
        userGames = [];
        friendsList = [];
        currentAchievements = [];
        currentResult = null;
        currentComparison = null;
        filterMode = 'all';
        comparisonFilter = 'all';

        document.getElementById('user-selection').style.display = 'block';
        document.getElementById('main-interface').style.display = 'none';
        document.getElementById('achievements-container').style.display = 'none';
        document.getElementById('filter-container').style.display = 'none';
        document.getElementById('comparison-container').style.display = 'none';
        document.getElementById('comparison-tab').style.display = 'none';
        document.getElementById('achievements').innerHTML = '';
        document.getElementById('friends-list').innerHTML = '';
        document.getElementById('comparison-achievements').innerHTML = '';

        const commonGamesSection = document.getElementById('common-games-section');
        if (commonGamesSection) {
            commonGamesSection.remove();
        }

        document.getElementById('start-btn').disabled = true;
        document.getElementById('start-btn').setAttribute('aria-disabled', 'true');
        document.getElementById('load-friends-btn').disabled = false;
        document.getElementById('compare-friend-btn').disabled = true;

        document.querySelectorAll('.filter-buttons button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.filter-buttons button').classList.add('active');

        document.querySelectorAll('.comparison-filters button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.comparison-filters button').classList.add('active');

        switchTab('games');

        displayUsers();
        document.getElementById('status').textContent = ' Sélectionnez votre compte Steam';
        document.getElementById('status').className = "info";
    }

    window.onload = init;
</script>

</body>
</html>